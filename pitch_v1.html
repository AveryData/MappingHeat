<!DOCTYPE html>
<style>

div.tooltip {
  position: absolute;
  text-align: center;
  width: 90px;
  height: 18px;
  padding: 2px;
  font: 6px sans-serif;
  background: #CCC5C5;
  border: 0px;
  border-radius: 8px;
}

</style>


<head>
  <title>Pitch Tool</title>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>

<h3>Mapping Heat</h1>
<select id="selectButton"></select>
<select id="selecttype"></select>
<input type="range" min="10", max="110", step="5", value="90" id="selectSpeed"/>
<output id="opacity">90 mph</output>
<div id="my_dataviz"></div>
<div style="display:inline-block; float:right" id="legend"></div>




<script>





// SETTING SVG and Canvas DIMENSIONS
// set the dimensions and margins of the graph
var margin = {top: 10, right: 30, bottom: 30, left: 60},
    width = 460 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg;
function initSvg () {
  var svg = d3.select("#my_dataviz")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
      "translate(" + margin.left + "," + margin.top + ")");
  return svg
}


var div = d3.select("body").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0);

// Speed selector
d3.select("input[type=range]#selectSpeed").on("input", function() {
  var speed = this.value;
  d3.select("output#opacity").text(d3.format(".0f")(speed) + " mph");
  return d3.selectAll("circle.points").attr("opacity", speed);
});




// CODE TO GO GET DATA
var baseApiUrl = 'http://localhost:5000'

// get pitcher data
function getPitcherData (pitcher) {
  return $.get({
    url: baseApiUrl +'/stats/pitcher?name=' + encodeURIComponent(pitcher),
    dataType: 'json',
    success: function (pitcherData) {
      return pitcherData.responseJson
    },
    error: function (error) {
      console.error('Error loading pitcher data', error)
    }
  })
}


// get pitch type
function getPitchTypeData (pitcher, pitch) {
  return $.get({
    url: baseApiUrl + '/stats/pitcher/pitch?name=' + encodeURIComponent(pitcher)
      + '&pitch=' + encodeURIComponent(pitch),
    dataType: 'json',
    success: function (pitchData) {
      return pitchData
    },
    error: function (error) {
      console.error('Error loading pitch type data', error)
    }
  })
}

// get pitch feature
function getPitchFeatureData (pitcher, feature, value) {
  return $.get({
    url: baseApiUrl + '/stats/pitcher?name=' + encodeURIComponent(pitcher)
      + '&feature=' + encodeURIComponent(feature) + '&value=' + encodeURIComponent(value),
    dataType: 'json',
    success: function (pitchData) {
      return pitchData
    },
    error: function (error) {
      console.error('Error loading pitch type data', error)
    }
  })
}

// get pitcher names
function getPitcherNames () {
  return $.get({
    url: baseApiUrl + '/stats/pitchers/names',
    dataType: 'json',
    success: function (pitcherNames) {
      return pitcherNames
    },
    error: function (error) {
      console.error('Error loading pitcher names', error)
    }
  })
}
// End code to go get data








// define color Map
endColor = 0
startColor = .4
var myColor = d3.scaleSequential()
  .interpolator(d3.interpolateRdYlBu)
  .domain([startColor,endColor])

// add the legend now
continuous("#my_dataviz", myColor);

// create continuous color legend
function continuous(selector_id, colorscale) {
  var legendheight = 200,
      legendwidth = 80,
      margin = {top: 10, right: 60, bottom: 10, left: 2};

  var canvas = d3.select(selector_id)
    .style("height", legendheight + "px")
    .style("width", legendwidth + "px")
    .style("position", "relative")
    .append("canvas")
    .attr("height", legendheight - margin.top - margin.bottom)
    .attr("width", 1)
    .style("height", (legendheight - margin.top - margin.bottom) + "px")
    .style("width", (legendwidth - margin.left - margin.right) + "px")
    .style("border", "1px solid #000")
    .style("position", "absolute")
    .style("top", (margin.top) + "px")
    .style("left", (margin.left) + "px")
    .node();

  var ctx = canvas.getContext("2d");

  var legendscale = d3.scaleLinear()
    .range([1, legendheight - margin.top - margin.bottom])
    .domain(colorscale.domain());

  // image data hackery based on http://bl.ocks.org/mbostock/048d21cf747371b11884f75ad896e5a5
  var image = ctx.createImageData(1, legendheight);
  d3.range(legendheight).forEach(function(i) {
    var c = d3.rgb(colorscale(legendscale.invert(i)));
    image.data[4*i] = c.r;
    image.data[4*i + 1] = c.g;
    image.data[4*i + 2] = c.b;
    image.data[4*i + 3] = 255;
  });
  ctx.putImageData(image, 0, 0);

  // A simpler way to do the above, but possibly slower. keep in mind the legend width is stretched because the width attr of the canvas is 1
  // See http://stackoverflow.com/questions/4899799/whats-the-best-way-to-set-a-single-pixel-in-an-html5-canvas
  /*
  d3.range(legendheight).forEach(function(i) {
    ctx.fillStyle = colorscale(legendscale.invert(i));
    ctx.fillRect(0,i,1,1);
  });
  */

  var legendaxis = d3.axisRight()
    .scale(legendscale)
    .tickSize(6)
    .ticks(8);

  var legSvg = d3.select(selector_id)
    .append("svg")
    .attr("height", (legendheight) + "px")
    .attr("width", (legendwidth) + "px")
    .style("position", "absolute")
    .style("left", "0px")
    .style("top", "0px")

  legSvg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(" + (legendwidth - margin.left - margin.right + 3) + "," + (margin.top) + ")")
    .call(legendaxis);
};

// function to start strike zone
function drawStrikeZone (pitchingData) {
  if(svg) {
    d3.selectAll('svg').remove();
  }
  continuous("#my_dataviz", myColor)
  svg = initSvg()

  // adds the x axis, y axis, and strike box

  // Add X axis
  var x = d3.scaleLinear()
    .domain([d3.min(pitchingData, function(c) { return c.plate_x}) - 3,
      d3.max(pitchingData, function(c) { return c.plate_x})])
    .range([ 0, width ])
  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x))

  // Add Y axis
  var y = d3.scaleLinear()
    .domain([d3.min(pitchingData, function(c) { return c.plate_z}),
      d3.max(pitchingData, function(c) { return c.plate_z})])
    .range([ height, 0])
  svg.append("g")
    .attr("class", "y axis")
    .call(d3.axisLeft(y))


  // PAINT STRIKE ZONE


  // Constants for the strike zone
  var far_left = -1;
  var far_right = 1;
  var top = 3.5;
  var bottom = 1;

  var h_1 = far_left + (far_right - far_left)/3
  var h_2 = far_left + 2*(far_right - far_left)/3

  var v_1 = bottom + (top - bottom)/3
  var v_2 = bottom + 2*(top - bottom)/3

  var v_middle = (top-bottom)/2 + bottom
  var h_middle = (far_right - far_left)/2

  var outer_height = v_middle/.8
  var outer_width = h_middle/1.8


  // Pain the inside borders (currently getting painted over)
  // h_1
  svg.append('line')
    .style("stroke", "grey")
    .style("stroke-width", .3)
    .style("stroke-dasharray", ("5, 3"))
    .attr("x1", x(h_1))
    .attr("y1", y(bottom))
    .attr("x2", x(h_1))
    .attr("y2", y(top));


  // h_2
  svg.append('line')
    .style("stroke", "grey")
    .style("stroke-width", .3)
    .style("stroke-dasharray", ("5, 3"))
    .attr("x1", x(h_2))
    .attr("y1", y(bottom))
    .attr("x2", x(h_2))
    .attr("y2", y(top));

  // v_1
  svg.append('line')
    .style("stroke", "grey")
    .style("stroke-width", .3)
    .style("stroke-dasharray", ("5, 3"))
    .attr("x1", x(far_left))
    .attr("y1", y(v_1))
    .attr("x2", x(far_right))
    .attr("y2", y(v_1));



  // v_2
  svg.append('line')
    .style("stroke", "grey")
    .style("stroke-width", .3)
    .style("stroke-dasharray", ("5, 3"))
    .attr("x1", x(far_left))
    .attr("y1", y(v_2))
    .attr("x2", x(far_right))
    .attr("y2", y(v_2));


  // Background sqaures

  // Bottom Row
  var bl = svg.append("rect")
    .attr("x", x(far_left))
    .attr("y", y(v_1))
    .attr("width", -x(far_left) + x(h_1))
    .attr("height",  -y(v_1)  + y(bottom))
    .style("fill", myColor(.33));

  var bm = svg.append("rect")
    .attr("x", x(h_1))
    .attr("y", y(v_1))
    .attr("width", -x(far_left) + x(h_1))
    .attr("height",  -y(v_1)  + y(bottom))
    .style("fill", myColor(.13));

  var br = svg.append("rect")
    .attr("x", x(h_2))
    .attr("y", y(v_1))
    .attr("width", -x(far_left) + x(h_1))
    .attr("height",  -y(v_1)  + y(bottom))
    .style("fill", myColor(.03));


  // Middle Row
  var ml = svg.append("rect")
    .attr("x", x(far_left))
    .attr("y", y(v_2))
    .attr("width", -x(far_left) + x(h_1))
    .attr("height",  -y(v_1)  + y(bottom))
    .style("fill", myColor(.12));

  var mm = svg.append("rect")
    .attr("x", x(h_1))
    .attr("y", y(v_2))
    .attr("width", -x(far_left) + x(h_1))
    .attr("height",  -y(v_1)  + y(bottom))
    .style("fill", myColor(.1));

  var mr = svg.append("rect")
    .attr("x", x(h_2))
    .attr("y", y(v_2))
    .attr("width", -x(far_left) + x(h_1))
    .attr("height",  -y(v_1)  + y(bottom))
    .style("fill", myColor(.22));


  // top Row
  var tl = svg.append("rect")
    .attr("x", x(far_left))
    .attr("y", y(top))
    .attr("width", -x(far_left) + x(h_1))
    .attr("height",  -y(v_1)  + y(bottom))
    .style("fill", myColor(.23));

  var tm = svg.append("rect")
    .attr("x", x(h_1))
    .attr("y", y(top))
    .attr("width", -x(far_left) + x(h_1))
    .attr("height",  -y(v_1)  + y(bottom))
    .style("fill", myColor(.07));

  var tr = svg.append("rect")
    .attr("x", x(h_2))
    .attr("y", y(top))
    .attr("width", -x(far_left) + x(h_1))
    .attr("height",  -y(v_1)  + y(bottom))
    .style("fill", myColor(.23));



  // Outer zones
  // Bottom Left
  var z_13_1 = svg.append("rect")
    .attr("x", x(far_left - outer_width))
    .attr("y", y(v_middle))
    .attr("width",x(far_left) - x(far_left - outer_width))
    .attr("height",  y(outer_height) )
    .style("fill", myColor(.13));

  var z_11_2 = svg.append("rect")
    .attr("x", x(far_left))
    .attr("y", y(bottom))
    .attr("width",(x(h_middle) - x(far_left))/2)
    .attr("height", -y(v_middle) + y(outer_height) + y(top) )
    .style("fill", myColor(.13));



      // bottom right
  var z_14_1 = svg.append("rect")
    .attr("x", x(far_right))
    .attr("y", y(v_middle))
    .attr("width", x(far_left) - x(far_left - outer_width))
    .attr("height",   y(outer_height))
    .style("fill", myColor(.04));


  var z_14_2 = svg.append("rect")
    .attr("x", x(far_left) + (x(h_middle) - x(far_left))/2)
    .attr("y", y(bottom))
    .attr("width",(x(h_middle) - x(far_left))/2)
    .attr("height", -y(v_middle) + y(outer_height) + y(top) )
    .style("fill", myColor(.04));



      // top left
  var z_11_1 = svg.append("rect")
    .attr("x", x(far_left - outer_width))
    .attr("y", y(v_middle) - y(outer_height))
    .attr("width",x(far_left) - x(far_left - outer_width))
    .attr("height",  y(outer_height) )
    .style("fill", myColor(.15));

  var z_11_2 = svg.append("rect")
    .attr("x", x(far_left))
    .attr("y", y(v_middle) - y(outer_height))
    .attr("width",(x(h_middle) - x(far_left))/2)
    .attr("height", -y(v_middle) + y(outer_height) + y(top) )
    .style("fill", myColor(.15));



  // top right
  var z_12_1 = svg.append("rect")
    .attr("x", x(far_right))
    .attr("y", y(v_middle) - y(outer_height))
    .attr("width",x(far_left) - x(far_left - outer_width))
    .attr("height",  y(outer_height) )
    .style("fill", myColor(.2));


  var z_12_2 = svg.append("rect")
    .attr("x", x(far_left) + (x(h_middle) - x(far_left))/2)
    .attr("y", y(v_middle) - y(outer_height))
    .attr("width",(x(h_middle) - x(far_left))/2)
    .attr("height", -y(v_middle) + y(outer_height) + y(top) )
    .style("fill", myColor(.2));

  // MAIN strike zone outline BOX
  var main_box_stroke_with = 3

  // top
  svg.append('line')
    .style("stroke", "grey")
    .style("stroke-width", main_box_stroke_with)
    .style("stroke-dasharray", ("10, 8"))
    .attr("x1", x(far_left))
    .attr("y1", y(top))
    .attr("x2", x(far_right))
    .attr("y2", y(top));

  // bottom
  svg.append('line')
    .style("stroke", "grey")
    .style("stroke-width", main_box_stroke_with)
    .style("stroke-dasharray", ("10, 8"))
    .attr("x1", x(far_left))
    .attr("y1", y(bottom))
    .attr("x2", x(far_right))
    .attr("y2", y(bottom));

  // left
  svg.append('line')
    .style("stroke", "grey")
    .style("stroke-width", main_box_stroke_with)
    .style("stroke-dasharray", ("10, 8"))
    .attr("x1", x(far_left))
    .attr("y1", y(bottom))
    .attr("x2", x(far_left))
    .attr("y2", y(top));

  // right
  svg.append('line')
    .style("stroke", "grey")
    .style("stroke-width", main_box_stroke_with)
    .style("stroke-dasharray", ("10, 8"))
    .attr("x1", x(far_right))
    .attr("y1", y(bottom))
    .attr("x2", x(far_right))
    .attr("y2", y(top));


  // add pitch dots
  svg.append('g')
    .selectAll("dot")
    .data(pitchingData)
    .enter()
    .append("circle")
    .attr("cx", function (d) { return x(d.plate_x); } )
    .attr("cy", function (d) { return y(d.plate_z); } )
    .attr("r", 1.5)
    .style("fill", "#010101")
    .on("mouseover", function(d) {
      div.transition()
        .duration(50)
        .style("opacity", .9);
      div.html(
        'Pitch Date: ' + d.game_date
        + "<br/>"
        + 'Outcome: ' + d.description
        + "<br/>"
        + 'Speed: ' + d.release_speed

      )
        .style("left", (d3.event.pageX) + "px")
        .style("top", (d3.event.pageY - 28) + "px");
    });

// BASE BALL
    // add baseball
    // var baseball = svg.append("circle")
    //   .attr("cx", x(0))
    //   .attr("cy",y(2.25))
    //   .attr("fx",0)
    //   .attr("fy",0)
    //   .attr("r",15)
    //   .style("fill", "#A1A1A1")
    //
    //   // Move the baseball
    //   var dragHandler = d3.drag()
    //       .on('drag', dragged)
    //       // .on('start', dragstarted);
    //
    //   dragHandler(baseball);
    //
    //   function dragged() {
    //       var current = d3.select(this);
    //       current
    //           .attr('cx', d3.event.x)
    //           .attr('cy', d3.event.y);
    //   }





} // End intialize










// STEP 1
// Start by getting the pitchers' names
getPitcherNames().then(function(names) {

  // add the options to the pitch name button
  d3.select("#selectButton")
    .selectAll('myOptions')
    .data(names)
    .enter()
    .append('option')
    .text(function (d) { return d; }) // text showed in the menu
    .attr("value", function (d) { return d; }) // corresponding value returned by the button

  // Get the selected name
  var selectedOption = d3.select('#selectButton').property("value")


  // STEP 2 - get the data for the selected name
  // Get the data for the default pitcher
  getPitcherData(selectedOption).then(function(pitchingData) {

    // add the options to the pitch type selector
    var pitch_types = d3.set(d3.values(pitchingData).map(function(d) {return d.pitch_type})).values()

    d3.select("#selecttype")
      .selectAll('myOptions')
      .data(pitch_types)
      .enter()
      .append('option')
      .text(function (d) { return d; }) // text showed in the menu
      .attr("value", function (d) { return d; }) // corresponding value returned by the button


    // STEP 3 - draw the axis and strike zone
    drawStrikeZone(pitchingData)

    // STEP 4 - wait for a new person
    // When the button is changed, run the updateChart function
    d3.select("#selectButton").on("change", function(d) {
      // recover the option that has been chosen
      var selectedOption = d3.select(this).property("value")

      // GO AND GET NEW DATA
      getPitcherData(selectedOption)
        .then(function (data) {
          drawStrikeZone(data)
        })
        // // STEP 5 - wait for a new pitch type
        // // When the button is changed, run the updateChart function
        // d3.select("#selecttype").on("change", function(d) {
        //   // recover the option that has been chosen
        //   var selectedType = d3.select('#selecttype').property("value")

        //   d3.selectAll('circle').remove()



        //       var new_dots = svg.append('g')
        //         .selectAll("dot")
        //         .data(data, function (d) {return d.pitch_type == selectedType})
        //         .enter()
        //         .append("circle")
        //           .attr("cx", function (d) { return x(d.plate_x); } )
        //           .attr("cy", function (d) { return y(d.plate_z); } )
        //           .attr("r", 1.5)
        //           .style("fill", "#12a3a2")
        //     }) // end new pitch type




        // //// the type selectors
        // getPitcherData(selectedOption)
        //   .then(function (data) {
        //     // Add dots
        //     //console.log(svg._groups[0])
        //     d3.selectAll('circle').remove()




        //     //console.log(data);
        //     //console.log(d3.values(data).map(function(d) {return d.pitch_type}));

        //     // add the options to the butto

        //     var selectedType = d3.select('#selecttype').property("value")

        //     console.log(selectedType)

        //     // Add X axis
        //     var x = d3.scaleLinear()
        //       .domain([d3.min(data, function(c) { return c.plate_x})-3, d3.max(data, function(c) { return c.plate_x})    ])
        //       .range([ 0, width ])
        //     svg.select('g.x.axis').call(d3.axisBottom(x));

        //     // Add Y axis
        //     var y = d3.scaleLinear()
        //       .domain([d3.min(data, function(c) { return c.plate_z}), d3.max(data, function(c) { return c.plate_z})    ])
        //       .range([ height, 0])
        //       svg.select('g.y.axis').call(d3.axisLeft(y));

        //     var new_dots = svg.append('g')
        //       .selectAll("dot")
        //       .data(data, function (d) {return d.pitch_type == selectedType})
        //       .enter()
        //       .append("circle")
        //         .attr("cx", function (d) { return x(d.plate_x); } )
        //         .attr("cy", function (d) { return y(d.plate_z); } )
        //         .attr("r", 1.5)
        //         .style("fill", "#12a3a2")
        //   })
    })
  })
})



</script>
